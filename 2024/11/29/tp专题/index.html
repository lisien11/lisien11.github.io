<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>tp专题 | L的博客</title><meta name="author" content="L"><meta name="copyright" content="L"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="url模式普通模式tp的路由结构是由模块,控制器,方法组成的    tp中默认的控制器就是IndexController 模块其实就是上层文件夹名称,也可以从代码中看出来   控制器方法其实就是类底下的方法了 不同tp的版本会有些许差异但本质还是没有区别都是文件名，类名，方法名 其url的访问形式就是 1http:&#x2F;&#x2F;xxxxx&#x2F;?m&#x3D;Home&amp;c&#x3D;Index&amp;a&#x3D;h_n&amp;">
<meta property="og:type" content="article">
<meta property="og:title" content="tp专题">
<meta property="og:url" content="https://lisien11.github.io/2024/11/29/tp%E4%B8%93%E9%A2%98/index.html">
<meta property="og:site_name" content="L的博客">
<meta property="og:description" content="url模式普通模式tp的路由结构是由模块,控制器,方法组成的    tp中默认的控制器就是IndexController 模块其实就是上层文件夹名称,也可以从代码中看出来   控制器方法其实就是类底下的方法了 不同tp的版本会有些许差异但本质还是没有区别都是文件名，类名，方法名 其url的访问形式就是 1http:&#x2F;&#x2F;xxxxx&#x2F;?m&#x3D;Home&amp;c&#x3D;Index&amp;a&#x3D;h_n&amp;">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/lisien11/lisien11.github.io/refs/heads/master/cover/cover73.jpg">
<meta property="article:published_time" content="2024-11-29T07:39:14.000Z">
<meta property="article:modified_time" content="2024-12-06T15:54:59.319Z">
<meta property="article:author" content="L">
<meta property="article:tag" content="php">
<meta property="article:tag" content="thinkphp">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/lisien11/lisien11.github.io/refs/heads/master/cover/cover73.jpg"><link rel="shortcut icon" href="/img/1.jpg"><link rel="canonical" href="https://lisien11.github.io/2024/11/29/tp%E4%B8%93%E9%A2%98/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":true,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'tp专题',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-12-06 23:54:59'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/LSE.css"><meta name="generator" content="Hexo 7.0.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://raw.githubusercontent.com/lisien11/lisien11.github.io/refs/heads/master/%E5%9B%BE%E7%89%87/1231.jpg" onerror="onerror=null;src='/img/lll.png'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">102</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">43</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">43</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首頁</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://raw.githubusercontent.com/lisien11/lisien11.github.io/refs/heads/master/cover/cover73.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="L的博客"><span class="site-name">L的博客</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首頁</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">tp专题</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-11-29T07:39:14.000Z" title="发表于 2024-11-29 15:39:14">2024-11-29</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-12-06T15:54:59.319Z" title="更新于 2024-12-06 23:54:59">2024-12-06</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/php/">php</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>13分钟</span></span><span class="post-meta-separator">|</span><span id="" data-flag-title="tp专题"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="twikoo_visitors"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="url模式"><a href="#url模式" class="headerlink" title="url模式"></a>url模式</h1><h2 id="普通模式"><a href="#普通模式" class="headerlink" title="普通模式"></a>普通模式</h2><p>tp的路由结构是由<code>模块</code>,<code>控制器</code>,<code>方法</code>组成的</p>
<img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241129-164601322.png" class="">  
<p>tp中默认的控制器就是IndexController</p>
<p>模块其实就是上层文件夹名称,也可以从代码中看出来<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241129-164855744.png" class="">  </p>
<p>控制器方法其实就是类底下的方法了</p>
<p>不同tp的版本会有些许差异但本质还是没有区别<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241129-185102283.png" class=""><br>都是文件名，类名，方法名</p>
<p>其url的访问形式就是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://xxxxx/?m=Home&amp;c=Index&amp;a=h_n&amp;xxx=xxx</span><br></pre></td></tr></table></figure>
<p>m代表模块名<br>c代表控制器名<br>a就是方法名<br>xxx就是其他参数了</p>
<h2 id="PATHINFO模式"><a href="#PATHINFO模式" class="headerlink" title="PATHINFO模式"></a>PATHINFO模式</h2><p>这个模式的url结构如下<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://xxxxx/index.php/Home/Index/h_n?xxx=xxxx</span><br></pre></td></tr></table></figure><br>这个方法同样是模块,控制器,方法,而参数就可以值使用正常的?来传<br>我们也可以通过如下方式来传参<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/?s=/Home/Index/h_n/name/LSE</span><br></pre></td></tr></table></figure><br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241129-170044965.png" class="">  </p>
<p>当然我们也可以像这样访问方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://xxxxxx/?s=/Home/Index/h_n&amp;xxx=xxxx</span><br><span class="line">http://xxxxxx/?s=/Home/Index/h_n/key/value</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="REWRITE模式and"><a href="#REWRITE模式and" class="headerlink" title="REWRITE模式and"></a>REWRITE模式and</h2><p>剩下两种的差别也不大我就直接贴手册了<br><a target="_blank" rel="noopener" href="https://www.kancloud.cn/manual/thinkphp/1697">https://www.kancloud.cn/manual/thinkphp/1697</a></p>
<h1 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h1><p>手册里讲的其实很清楚了，唯一要注意的是再不同目录下的config.php的路由定义差别<br>如果再模块下的config.php定义时时如下的<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;URL_ROUTE_RULES&#x27;</span> =&gt; array(</span><br><span class="line">    <span class="string">&#x27;shell/:cmd&#x27;</span> =&gt; array(<span class="string">&#x27;Index/shell&#x27;</span>,<span class="string">&#x27;haha=123&#x27;</span>)</span><br><span class="line">    )</span><br></pre></td></tr></table></figure><br>上面的映射是将Home控制器即默认控制器底下的shell映射到Index/shell。<br>再访问时的url变化其实是下面这样的<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://xxxx/index.php/Home/Index/shell =&gt; http://xxxxx/index.php/Home/Index/shell</span><br></pre></td></tr></table></figure><br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241129-231823765.png" class="">  </p>
<p>是的再模块文件下的config定义的路由前面默认会有应该模块名</p>
<p>而在app下即应用目录下，其实就是再全局定义了，我们的定义方法和模块的有小小的不同。<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x27;URL_ROUTE_RULES&#x27; =&gt; array(</span><br><span class="line">    &#x27;shell/:cmd&#x27; =&gt; array(&#x27;Home/Index/shell&#x27;,&#x27;haha=123&#x27;)</span><br><span class="line">    )</span><br></pre></td></tr></table></figure><br>再指定后面的路由时我们需要连同模块一起带上<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://xxxx/index.php/Index/shell =&gt; http://xxxxx/index.php/Home/Index/shell</span><br></pre></td></tr></table></figure><br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241129-231845509.png" class="">  </p>
<h2 id="web570"><a href="#web570" class="headerlink" title="web570"></a>web570</h2><p>首先这个附件给的是APP目录即其定义的路由是全局路由<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241129-175226674.png" class=""><br>搜config.php可以发现其定义的代码<br>其利用了闭包路由<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241129-232151753.png" class=""><br>其将ctfshow后的两个参数传到call_user_func这个回调函数里<br>我们直接通过assert来命令执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https://b25276a0-7954-4adf-b6e4-3fffcd5e0d8f.challenge.ctf.show/index.php/ctfshow/assert/eval(&quot;$_POST[1]&quot;)</span><br><span class="line"></span><br><span class="line">1=system(&quot;cat /flag_is_here&quot;);</span><br></pre></td></tr></table></figure>
<img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241129-175151491.png" class="">  
<h1 id="show命令执行"><a href="#show命令执行" class="headerlink" title="show命令执行"></a>show命令执行</h1><h2 id="无缓存，默认的think引擎-因为php引擎的命令执行比较简单有提一嘴php引擎"><a href="#无缓存，默认的think引擎-因为php引擎的命令执行比较简单有提一嘴php引擎" class="headerlink" title="无缓存，默认的think引擎(因为php引擎的命令执行比较简单有提一嘴php引擎)"></a>无缓存，默认的think引擎(因为php引擎的命令执行比较简单有提一嘴php引擎)</h2><p>再thinkphp3.2.3中show函数存在着命令执行的问题。下面会将会对其进行分析<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241130-154353365.png" class=""><br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241130-154411823.png" class=""><br>步入fetch函数<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241130-154459704.png" class=""><br>我们可以看到当TMPL_ENGINE_TYPE的配置信息为php时会直接将我们传入show的参数放入eval中命令执行<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241130-155154304.png" class=""><br>C函数的作用就是从config中提取TMPL_ENGINE_TYPE的内容</p>
<img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241130-155249459.png" class="">  
<p>默认的为Think<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241130-155355534.png" class=""><br>之后将我们传入的参数组成array然后传入listen解析出处理</p>
<img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241130-155708786.png" class="">  
<p>进入listen后会发现一个类下的exec函数</p>
<img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241130-155921909.png" class="">  
<p>将tag赋值为Run并且实例化name指向的类</p>
<p>也就是最后返回的时ReadHtmlCacheBehavior-&gt;Run($params)</p>
<p>而$params也就是我们之前传入的参数经过包装后的数组</p>
<img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241130-160432166.png" class="">  
<img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241130-160545701.png" class="">  
<p>之后就是判断引擎，也就是think，然后获取我们传入show的参数，和前缀(不太清楚这是啥)<br>然后进入if判断，检查一下是否存在缓存，存在就直接通过Storage::load加载。因为我们是第一次进入所以并没有缓存。<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241130-161610565.png" class=""><br>对tpl进行赋值 步入instance方法。<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241130-161820115.png" class=""><br>可以发现其判断传入的路径是否为实例，是否为类，如果不是实例但是为类就将其实例化返回。<br>返回的类是Template<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241130-161339372.png" class=""><br>然后使用这个类的fetch<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241130-162259764.png" class=""><br>之后进入loadTemplate<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241130-162539859.png" class=""><br>其会判断传入的参数是否为文件，不为文件就会尝试写入缓存，缓存的路径为，配置中的缓存路径加上。文件名为缓存的内容，拼接上设置预设的缓存后缀。默认为.php</p>
<p>然后处理要写入的内容<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241130-163012387.png" class=""><br>最终渲染结果为，在前面加一个判断是否定义THINK_PATH的函数，如果定义了就可以指向后面的代码，即我们传入的参数</p>
<p>然后调用Storage的put方法。<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241130-163314988.png" class=""><br>因为其没有put方法于是触发了<code>__callstatic</code>(<code>__callstatic</code>与<code>__call</code>相似只是前者用于类后者用于对象)那么<code>$method</code>就为put而<code>$args</code>就为一个存储路径和写入内容的一个数组</p>
<p>。然后使用回调函数来调用<code>self::$handler</code>的put方法，参数为<code>$arg</code><br>而<code>self::$handler</code>在connect方法有进行赋值赋值</p>
<p>如果我们在一开始传参之前就在这里下个断点会发现其实在一开始传参就已经直接运行到了这里<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241130-164009402.png" class=""><br>其实例化的类为File类。我们看一下这个类<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241130-164103876.png" class=""><br>其put方法就是一个文件写入的方法</p>
<p>写入文件后会调用到<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241130-164600618.png" class="">  </p>
<p>Stirage::load同样没有这个方法，所以会加载到File的load方法中<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241130-164719561.png" class=""><br>而filename就是缓存的路径<br>这样就导致了文件包含，从而进行了命令执行</p>
<h2 id="有缓存"><a href="#有缓存" class="headerlink" title="有缓存"></a>有缓存</h2><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241130-165031018.png" class="">  
<p>我们直接调到之前判断有无缓存的部分<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241130-165432299.png" class=""><br>其chek缓存的方法其实就是调用File类的has方法来查看是否存在缓存文件</p>
<p>会发现如果有缓存会直接调用Storage::load<br>Storage::load其实就是文件包含了</p>
<p><strong>纠正一下我刚才在上面说的都是实例化类，但其实应该叫实例化控制器，虽然其实都差不多</strong><br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241130-170139702.png" class="">  </p>
<h2 id="web571"><a href="#web571" class="headerlink" title="web571"></a>web571</h2><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241130-165734544.png" class="">  
<img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241130-165747439.png" class="">  
<p>可以发现在index方法里写了一个show函数，而show函数内的参数</p>
<img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241130-170336770.png" class="">  
<p>上面手册的方法不行，可能是配置没开，这里直接get传值即可<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241130-170617069.png" class="">  </p>
<img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241130-170731111.png" class="">  
<h1 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h1><h2 id="web572"><a href="#web572" class="headerlink" title="web572"></a>web572</h2><p>在开启debug是tp会自动记录日志，而日志的位置位于<br>Application/Runtime/Logs/模块/xx_xx_xx.log</p>
<img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241130-173054080.png" class="">  
<img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241130-173103615.png" class="">  
<img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241130-173037789.png" class="">  
<p>可以发现日志里index.php直接就是马<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241130-173328065.png" class="">  </p>
<h1 id="think3-2-3sql注入"><a href="#think3-2-3sql注入" class="headerlink" title="think3.2.3sql注入"></a>think3.2.3sql注入</h1><p>感觉干巴巴的调下去会很无聊，所以我这里就把sql的函数调一下看看，tp到底是怎么实现这些函数的</p>
<h2 id="M"><a href="#M" class="headerlink" title="M"></a>M</h2><p><a target="_blank" rel="noopener" href="https://www.thinkphp.cn/info/123.html">https://www.thinkphp.cn/info/123.html</a><br>看起官方文档可以知道M函数的基础用法，其作用就是实例化一个模型，而这个函数可以在没有定义任何实例时实例一个数据表的模型。<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-103323864.png" class=""><br>我们可以看到当我们传入的name为xxx:xxx时其会分割传入<code>$class</code>和<code>$name</code>如果没有定义类名就赋值为默认的<code>Think\\Midel</code>控制器，然后将<code>connection . $tablePrefix . $name . &#39;_&#39; . $class</code>进行拼接。因为我们没有设定前缀和connection，所以返回的就是name和class拼接的结果。从文档我们可以看出<code>$connection</code>是用于数据库连接的参数，所以后面应该会从配置中得到数据库连接信息并赋值给这个变量</p>
<p>步入实例化类。<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-105137218.png" class=""><br>我们可以看到其直接跳到了autoload，这是因为其在程序开始时初始时的操作导致的<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-105116615.png" class=""><br>我们继续看autoload()</p>
<p>其先检测map内有没有缓存，有的话就直接文件包含<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-105619667.png" class=""><br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-105643467.png" class=""><br>然后进入其<code>__construc</code>,之后初始化为一个value几乎为空的类，之后就是一串赋值操作</p>
<img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-105859339.png" class="">  
<p>我们步入db方法。<br>然后步入这个Db的实例化操作<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-110020560.png" class=""><br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-110249326.png" class=""><br>其将我们传入的空config继续md5编码，然后实验parseConfig来得到配置中的数据库连接信息<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-110411509.png" class=""><br>因为其config为空所以其直接通过C方法来获取config.php的配置信息，然后组成数组赋值给config变量。然后返回<code>$config</code></p>
<p><code>$options</code>其实就是被赋值为了连接信息。<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-110721641.png" class=""><br>然后实例化一个mysql类其参数为连接信息<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-110945485.png" class=""><br>连接配置被存到类里的config<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-111143335.png" class=""><br>最后就将这个mysql类返回<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-111428448.png" class=""><br>也就是<code>_db[$linkNum]</code>被赋值为这个类的实例<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-111415896.png" class=""><br>然后db被赋值为这个实例<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-111627593.png" class=""><br>最后就是判断我们这个table是否存在如果存在就返回我们这个配置好的模型。<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-111808580.png" class=""><br>我们一直往下调回发现这个check其实就是用 <code>$this-&gt;query($sql);</code>来查询这个表是存在</p>
<img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-112105794.png" class="">  
<img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-112118423.png" class="">  
<p>我们看这个模板类其重点的两部分就是db属性和exp中的selectSql。<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-112417294.png" class=""><br>而这个模板语句在最开始其实就语句写好了</p>
<h2 id="select"><a href="#select" class="headerlink" title="select"></a>select</h2><p>首先是select函数在查询时的代码如下<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Sql</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$User</span>=<span class="title function_ invoke__">M</span>(<span class="string">&quot;users&quot;</span>);</span><br><span class="line">    <span class="variable">$b</span>=<span class="variable">$User</span>-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line">    <span class="title function_ invoke__">var_dump</span>(<span class="variable">$b</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>上面的代码实例化了一个模板，这个模板就是数据库的users表。然后直接调用select来查询这个表的使用内容相当于使用了下面的sql代码<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from users</span><br></pre></td></tr></table></figure><br>下面开始调试</p>
<img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241201-233114080.png" class="">  
<p>前面就是加载一下预定义的东西。<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241201-233325123.png" class=""><br>再次进入db的select函数。传入的参数<code>$options</code>就是我们的tablename users<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241201-233541547.png" class=""><br>前面的的modle是个空数组，<code>$options[&#39;bind&#39;]</code>也是空的<br>我们步入buildSelectSql。<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241201-233727226.png" class=""><br>再步入parseSql<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241201-233845473.png" class=""><br>我们可以发现这里是使用str_replace()来对<code>$sql</code>进行替换。sql就是预定义的一个sql查询语句如下<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT%DISTINCT% %FIELD% FROM %TABLE%%FORCE%%JOIN%%WHERE%%GROUP%%HAVING%%ORDER%%LIMIT% %UNION%%LOCK%%COMMENT%</span><br></pre></td></tr></table></figure><br>我们可以发现其应该就是通过这种替换，从而达到生成最终的sql语句<br>我们继续步入<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241201-234145531.png" class="">  </p>
<p>其使用array_walk来回调处理我们的字符串<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241201-234255582.png" class=""><br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241201-234318041.png" class=""><br>我们可以发现其实就是使用第二个参数的类方法来处理第一个参数，所以我们会跳到parseKey方法<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241201-234658369.png" class=""><br>唯一有点疑问的是<code>$this</code>会指向Mysql控制器不懂。但无伤大雅<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241201-234449322.png" class=""><br>我们可以发现其将我们的参数用反引号包裹，然后返回。</p>
<p>后面的我就不调了，都是类似于这种操作<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241201-235442247.png" class=""><br>然后步入query<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241201-235541565.png" class=""><br>将queryStr赋值为我们的sql语句<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241202-000018625.png" class="">  </p>
<img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241202-000042218.png" class="">  
<img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241202-000043856.png" class="">  
<p>最后使用PDO进行sql查询</p>
<h2 id="Options可控导致的sql注入"><a href="#Options可控导致的sql注入" class="headerlink" title="$Options可控导致的sql注入"></a>$Options可控导致的sql注入</h2><p>我们使用sql查询有如下俩种<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$b</span>=<span class="variable">$User</span>-&gt;<span class="title function_ invoke__">select</span>(<span class="variable">$id</span>);</span><br><span class="line"><span class="variable">$b</span>=<span class="variable">$User</span>-&gt;<span class="title function_ invoke__">find</span>(<span class="variable">$id</span>);</span><br></pre></td></tr></table></figure><br>其中<code>$id</code>可填可不填，<code>$id</code>其实就是所谓的<code>$Options</code><br>find和select这两个函数因为<code>$Options</code>原理其实是一样的代码也很像所以我这里就直接审select函数的了<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$id</span>=<span class="title function_ invoke__">I</span>(<span class="string">&#x27;GET.id&#x27;</span>);</span><br><span class="line"><span class="variable">$User</span>=<span class="title function_ invoke__">M</span>(<span class="string">&quot;users&quot;</span>);</span><br><span class="line"><span class="variable">$b</span>=<span class="variable">$User</span>-&gt;<span class="title function_ invoke__">select</span>(<span class="variable">$id</span>);</span><br></pre></td></tr></table></figure><br>首先如上代码我们先传?id=1’来调一调看一下是哪里对参数进行了处理<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-192311628.png" class=""><br>我们进入select函数，会发现其先对判断我们的参数是否为字符串或者数字，如果是就进行处理<br>其将我们的参数传入<code>$where[id]</code>在将<code>$where</code>传给清空后的<code>$options</code>,<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-192646098.png" class=""><br>随后传入_parseOptions()方法，我们步入<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-192803981.png" class=""><br>然后将<code>$options</code>和一个空数组进行merge<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-192924053.png" class=""><br>这个函数如果输入空数组与正常数组，合并后内容不变<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-151800587.png" class="">  </p>
<p>经过一段赋值之后检测<code>$options[&#39;where&#39;]</code>是否为空是否为数组等，通过后就对参数进行二次处理<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-200710250.png" class=""><br>其将<code>$options[&#39;where&#39;]</code>和其key传入_parseType()进行处理<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-201114142.png" class=""><br>步入 _parseType()<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-201312553.png" class=""><br>步入发现其会将<code>$options[&#39;where&#39;]</code>的内容经过intval来处理，这导致我们传入的1’被转换成数字1</p>
<p>那么我们就要想办法让其不要进入这个方法。我们回顾一下上面审的就会发现</p>
<img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-212828301.png" class="">  
<p>只要我们让<code>$options[&#39;where&#39;]</code>不为数组就不会进入_parseType<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-213045323.png" class=""><br>而是直接返回了<code>$options</code></p>
<p>而返回了<code>$options</code>后的流程其实我们上面调select()函数时已经调过了<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-213403051.png" class=""><br>其对我们传入的内容进行拼接，其数组的key为where，union啊这些参数应该不少都有可以进行sql注入，因为我们最常见最简单就是were导致的sql注入我这里就演示这个了</p>
<p>我们传入<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id[where]=1&#x27;</span><br></pre></td></tr></table></figure><br>经过上面的流程最终就会导致sql语句变为<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM `users` WHERE 1&#x27; </span><br></pre></td></tr></table></figure><br>所以我们只要我们传入的id为数组就可以绕过waf</p>
<img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-214908420.png" class="">  
<img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-215143669.png" class="">  
<img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-215600928.png" class="">  
<p>甚至直接注入到%FIELD%使得语句直接变为<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select database();</span><br></pre></td></tr></table></figure><br>感觉审过java后回过头审php会轻松很多。上面的漏洞审计我只看来payload和就大致能审出来了</p>
<h2 id="where-exp注入"><a href="#where-exp注入" class="headerlink" title="where exp注入"></a>where exp注入</h2><p>关于这个函数的注入我个人准备自己审，不看网上的审计过程<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$id</span>=<span class="title function_ invoke__">I</span>(<span class="string">&#x27;GET.id&#x27;</span>);</span><br><span class="line"><span class="variable">$User</span>=<span class="title function_ invoke__">M</span>(<span class="string">&quot;users&quot;</span>);</span><br><span class="line"><span class="variable">$b</span>=<span class="variable">$User</span>-&gt;<span class="title function_ invoke__">where</span>(<span class="variable">$id</span>)-&gt;<span class="title function_ invoke__">find</span>();</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$b</span>);</span><br></pre></td></tr></table></figure><br>我们给id传入1’简单调试一下<br>简单调试了一下发现其并没有过滤直接将其拼接再sql语句里了<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-222732401.png" class=""><br>首先检测其是否为字符串，且不为空，然后进行一个赋值的逻辑，最后赋值的结果就是<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$where[&#x27;_string&#x27;]=1&#x27;</span><br></pre></td></tr></table></figure><br>然后将$where直接赋值到options[‘where’]中感觉和上面的已经有点联系了</p>
<img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-223107922.png" class="">  
<p>这次到这里虽然options[‘where’]是数组，但是因为只有key为id，username，password时才会进入这个_parseType()预渲染方法。所以其不会被intval<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-225151721.png" class="">  </p>
<p>我们直接调到where的拼接逻辑去<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-223309284.png" class=""><br>前面的操作用处不大，我们步入parseThinkWhere，<img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-223353926.png" class=""><br>可以发现其并没有处理而是直接赋值<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-223427790.png" class=""><br>然后返回被括号包裹的<code>$whereStr</code><br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-223522475.png" class=""><br>然后拼接拼接的结果其实就是<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `users` <span class="keyword">WHERE</span> ( <span class="number">1</span><span class="string">&#x27; ) LIMIT 1  </span></span><br></pre></td></tr></table></figure><br>明显可以sql注入payload如下<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-223652518.png" class=""><br><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/index.php/Home/Index/sql?id=0 ) union select 1,2,database()--+</span><br></pre></td></tr></table></figure></p>
<p>可以知道这明显和网上的exp注入不一样啊<br>看一下文章可以发现网上的exp注入其实是应对下面的情况<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$User = D(&#x27;Users&#x27;);</span><br><span class="line">// 先构建查询条件,再执行查询</span><br><span class="line">$map = array(&#x27;username&#x27; =&gt; $_GET[&#x27;username&#x27;]);</span><br><span class="line">// $map = array(&#x27;username&#x27; =&gt; I(&#x27;username&#x27;));</span><br><span class="line">$user = $User-&gt;where($map)-&gt;find();</span><br><span class="line">var_dump($user);</span><br></pre></td></tr></table></figure><br>我们可以看到其定义了<code>$where</code>的key为username。我们来调一下看看会有什么不同</p>
<img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-225447334.png" class="">  
<p>首先<code>$this-&gt;options[&#39;where&#39;]</code>会被直接复制为<code>$where</code><br>而其key已经提前定义了，也就是说我们传入的username是会进入_parseType()的。<br>但是经过调试后会发现其并没有对我们的参数进行修改</p>
<p>怀疑渲染是出现再拼接步骤的处理上</p>
<img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-230629852.png" class="">  
<p>我们一路往下调就会调到parseValue()方法。我们可以发现如果传入的参数为字符串，且value值不在bind的key中就会使用，其就会使用escapeString来使得’被转义，然后使用引号包裹<br>组成的sql语句如下<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `users` <span class="keyword">WHERE</span> `username` <span class="operator">=</span> <span class="string">&#x27;1\&#x27;&#x27; LIMIT 1  </span></span><br></pre></td></tr></table></figure><br>这时我个人认为的绕过方法为两种<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-231649221.png" class=""><br>一种是给bind赋值我们的注入语句，这样其返回的<code>$value</code>就不会被’’包裹自然就可以再拼接后进行sql注入了。</p>
<p>第二种应该就是我们要调的exp注入了。我们看第二个判断语句可以发现我们的<code>$value[0]</code>只要为exp其<code>$value</code>也没有被单引号包裹</p>
<p>我这里先尝试第二种，第二种我们知道传值的变量，而第一种目前还不知道如何传入bind</p>
<img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-232721269.png" class="">  
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/index.php/Home/Index/sql?name[0]=exp&amp;name[1]= =1 union select 1,2,database();--+</span><br></pre></td></tr></table></figure>
<p>然后我又调了一下发现不对<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-233045091.png" class=""><br>这个<code>$exp</code>怎么被赋值了，而当<code>$exp</code>被赋值为exp时其返回的<br><code>$whereStr</code> 就是没有经过parseValue处理的<code>$key . &#39; &#39; . $val[1];</code>只能说误打误撞吧<br><img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-233532276.png" class=""><br>我们可以看到如果我们传入的username参数为数组，就会对<code>$exp</code>复制<code>$exp</code>被直接复制为了val[0]<br>说实话真有点巧了，当初发现这个注入方法的是不是也是这样发现的呢?</p>
<h2 id="where-bind注入"><a href="#where-bind注入" class="headerlink" title="where bind注入"></a>where bind注入</h2><p>原本我以为这个会和上面的exp注入方法是一样的结果发现，还是有不小差别的</p>
<img src="/2024/11/29/tp%E4%B8%93%E9%A2%98/IMG_20241206-233826733.png" class="">  
<p>我们调到这里这个bind会发现请key和val拼接了一个=:<br>这导致我无法想之前一样进行sql注入</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://lisien11.github.io">L</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://lisien11.github.io/2024/11/29/tp%E4%B8%93%E9%A2%98/">https://lisien11.github.io/2024/11/29/tp%E4%B8%93%E9%A2%98/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://lisien11.github.io" target="_blank">L的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/php/">php</a><a class="post-meta__tags" href="/tags/thinkphp/">thinkphp</a></div><div class="post_share"><div class="social-share" data-image="https://raw.githubusercontent.com/lisien11/lisien11.github.io/refs/heads/master/cover/cover73.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/12/05/DASCTF-Apr-2023%E5%A4%8D%E7%8E%B0/" title="DASCTF Apr.2023复现"><img class="cover" src="https://raw.githubusercontent.com/lisien11/lisien11.github.io/refs/heads/master/cover/cover37.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">DASCTF Apr.2023复现</div></div></a></div><div class="next-post pull-right"><a href="/2024/11/28/%E7%8E%84%E6%9C%BA%E7%AC%AC%E4%B8%89%E7%AB%A0-linux%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81-%E9%9A%90%E8%97%8F/" title="玄机第三章-linux权限维持-隐藏"><img class="cover" src="https://raw.githubusercontent.com/lisien11/lisien11.github.io/refs/heads/master/cover/cover54.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">玄机第三章-linux权限维持-隐藏</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/05/12/Docker-PHP%E8%A3%B8%E6%96%87%E4%BB%B6%E6%9C%AC%E5%9C%B0%E5%8C%85%E5%90%AB/" title="Docker PHP裸文件本地包含"><img class="cover" src="https://raw.githubusercontent.com/lisien11/lisien11.github.io/refs/heads/master/cover/cover48.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-12</div><div class="title">Docker PHP裸文件本地包含</div></div></a></div><div><a href="/2024/01/21/php%E4%BC%AA%E5%8D%8F%E8%AE%AE-1/" title="php伪协议"><img class="cover" src="https://raw.githubusercontent.com/lisien11/lisien11.github.io/refs/heads/master/cover/cover13.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-21</div><div class="title">php伪协议</div></div></a></div><div><a href="/2024/03/11/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8B%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%80%83%E9%80%B8/" title="php反序列化之字符串逃逸"><img class="cover" src="https://raw.githubusercontent.com/lisien11/lisien11.github.io/refs/heads/master/cover/cover19.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-03-11</div><div class="title">php反序列化之字符串逃逸</div></div></a></div><div><a href="/2024/03/15/php%E7%89%B9%E6%80%A7-1/" title="php特性"><img class="cover" src="https://raw.githubusercontent.com/lisien11/lisien11.github.io/refs/heads/master/cover/cover14.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-03-15</div><div class="title">php特性</div></div></a></div><div><a href="/2024/05/14/think-php3-2-3%E7%9A%84%E7%AE%80%E5%8D%95%E5%AE%A1%E8%AE%A1%E5%8A%A8%E8%B0%83/" title="think_php3.2.3的简单审计动调"><img class="cover" src="https://raw.githubusercontent.com/lisien11/lisien11.github.io/refs/heads/master/cover/cover61.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-14</div><div class="title">think_php3.2.3的简单审计动调</div></div></a></div><div><a href="/2023/11/25/%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" title="序列化与反序列化"><img class="cover" src="https://raw.githubusercontent.com/lisien11/lisien11.github.io/refs/heads/master/cover/cover80.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-25</div><div class="title">序列化与反序列化</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://raw.githubusercontent.com/lisien11/lisien11.github.io/refs/heads/master/%E5%9B%BE%E7%89%87/1231.jpg" onerror="this.onerror=null;this.src='/img/lll.png'" alt="avatar"/></div><div class="author-info__name">L</div><div class="author-info__description">我只是一个平平无奇路过的普通大学生罢了</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">102</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">43</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">43</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/lisien11"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/lisien11" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:2488218724@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">无人问津也好，技不如人也罢，你都要试着安静下来，去做自己该做的事，而不是让内心烦躁焦虑，毁掉你本就不多的热情和定力。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#url%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.</span> <span class="toc-text">url模式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%99%AE%E9%80%9A%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.1.</span> <span class="toc-text">普通模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PATHINFO%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.2.</span> <span class="toc-text">PATHINFO模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#REWRITE%E6%A8%A1%E5%BC%8Fand"><span class="toc-number">1.3.</span> <span class="toc-text">REWRITE模式and</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1"><span class="toc-number">2.</span> <span class="toc-text">路由</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#web570"><span class="toc-number">2.1.</span> <span class="toc-text">web570</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#show%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C"><span class="toc-number">3.</span> <span class="toc-text">show命令执行</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A0%E7%BC%93%E5%AD%98%EF%BC%8C%E9%BB%98%E8%AE%A4%E7%9A%84think%E5%BC%95%E6%93%8E-%E5%9B%A0%E4%B8%BAphp%E5%BC%95%E6%93%8E%E7%9A%84%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%AF%94%E8%BE%83%E7%AE%80%E5%8D%95%E6%9C%89%E6%8F%90%E4%B8%80%E5%98%B4php%E5%BC%95%E6%93%8E"><span class="toc-number">3.1.</span> <span class="toc-text">无缓存，默认的think引擎(因为php引擎的命令执行比较简单有提一嘴php引擎)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%89%E7%BC%93%E5%AD%98"><span class="toc-number">3.2.</span> <span class="toc-text">有缓存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#web571"><span class="toc-number">3.3.</span> <span class="toc-text">web571</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%97%A5%E5%BF%97"><span class="toc-number">4.</span> <span class="toc-text">日志</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#web572"><span class="toc-number">4.1.</span> <span class="toc-text">web572</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#think3-2-3sql%E6%B3%A8%E5%85%A5"><span class="toc-number">5.</span> <span class="toc-text">think3.2.3sql注入</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#M"><span class="toc-number">5.1.</span> <span class="toc-text">M</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#select"><span class="toc-number">5.2.</span> <span class="toc-text">select</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Options%E5%8F%AF%E6%8E%A7%E5%AF%BC%E8%87%B4%E7%9A%84sql%E6%B3%A8%E5%85%A5"><span class="toc-number">5.3.</span> <span class="toc-text">$Options可控导致的sql注入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#where-exp%E6%B3%A8%E5%85%A5"><span class="toc-number">5.4.</span> <span class="toc-text">where exp注入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#where-bind%E6%B3%A8%E5%85%A5"><span class="toc-number">5.5.</span> <span class="toc-text">where bind注入</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/12/08/%E5%9B%BD%E5%9F%8E%E6%9D%AF/" title="国城杯"><img src="https://raw.githubusercontent.com/lisien11/lisien11.github.io/refs/heads/master/cover/cover80.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="国城杯"/></a><div class="content"><a class="title" href="/2024/12/08/%E5%9B%BD%E5%9F%8E%E6%9D%AF/" title="国城杯">国城杯</a><time datetime="2024-12-08T07:29:54.000Z" title="发表于 2024-12-08 15:29:54">2024-12-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/12/05/DASCTF-Apr-2023%E5%A4%8D%E7%8E%B0/" title="DASCTF Apr.2023复现"><img src="https://raw.githubusercontent.com/lisien11/lisien11.github.io/refs/heads/master/cover/cover37.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="DASCTF Apr.2023复现"/></a><div class="content"><a class="title" href="/2024/12/05/DASCTF-Apr-2023%E5%A4%8D%E7%8E%B0/" title="DASCTF Apr.2023复现">DASCTF Apr.2023复现</a><time datetime="2024-12-05T13:54:06.000Z" title="发表于 2024-12-05 21:54:06">2024-12-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/11/29/tp%E4%B8%93%E9%A2%98/" title="tp专题"><img src="https://raw.githubusercontent.com/lisien11/lisien11.github.io/refs/heads/master/cover/cover73.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="tp专题"/></a><div class="content"><a class="title" href="/2024/11/29/tp%E4%B8%93%E9%A2%98/" title="tp专题">tp专题</a><time datetime="2024-11-29T07:39:14.000Z" title="发表于 2024-11-29 15:39:14">2024-11-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/11/28/%E7%8E%84%E6%9C%BA%E7%AC%AC%E4%B8%89%E7%AB%A0-linux%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81-%E9%9A%90%E8%97%8F/" title="玄机第三章-linux权限维持-隐藏"><img src="https://raw.githubusercontent.com/lisien11/lisien11.github.io/refs/heads/master/cover/cover54.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="玄机第三章-linux权限维持-隐藏"/></a><div class="content"><a class="title" href="/2024/11/28/%E7%8E%84%E6%9C%BA%E7%AC%AC%E4%B8%89%E7%AB%A0-linux%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81-%E9%9A%90%E8%97%8F/" title="玄机第三章-linux权限维持-隐藏">玄机第三章-linux权限维持-隐藏</a><time datetime="2024-11-28T05:44:15.000Z" title="发表于 2024-11-28 13:44:15">2024-11-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/11/26/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/" title="权限维持"><img src="https://raw.githubusercontent.com/lisien11/lisien11.github.io/refs/heads/master/cover/cover17.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="权限维持"/></a><div class="content"><a class="title" href="/2024/11/26/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/" title="权限维持">权限维持</a><time datetime="2024-11-26T14:53:39.000Z" title="发表于 2024-11-26 22:53:39">2024-11-26</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By L</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat-btn" type="button" title="聊天"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>(() => {
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo.lse11.xyz',
      region: 'ap-guangzhou',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(init,0)
    else getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(init)
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo.lse11.xyz',
      region: 'ap-guangzhou',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else {
      loadTwikoo()
      
    }
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><script async data-pjax src="/js/LSE.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>